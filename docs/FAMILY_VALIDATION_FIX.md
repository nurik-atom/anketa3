# Исправление валидации семьи в анкете

## Проблема

После разделения поля "члены семьи" на категории валидация выдавала ошибки для пустых элементов массивов:
- `Поле Тип родства обязательно` (несколько раз)  
- `Поле Год рождения обязательно` (несколько раз)
- `Поле Профессия обязательно` (несколько раз)

## Причина

Laravel валидирует все элементы в массиве, даже если они пустые. Когда пользователь добавлял только одного родителя, но в массиве оставались пустые элементы, валидация требовала заполнения всех полей.

## Решение

### 1. Добавлен метод фильтрации `filterEmptyFamilyElements()`

```php
private function filterEmptyFamilyElements()
{
    // Фильтруем родителей - удаляем полностью пустые записи
    if (is_array($this->parents)) {
        $this->parents = array_filter($this->parents, function($parent) {
            return !empty($parent['relation']) || !empty($parent['birth_year']) || !empty($parent['profession']);
        });
        $this->parents = array_values($this->parents); // Переиндексируем
    }

    // Фильтруем братьев и сестер
    if (is_array($this->siblings)) {
        $this->siblings = array_filter($this->siblings, function($sibling) {
            return !empty($sibling['relation']) || !empty($sibling['birth_year']);
        });
        $this->siblings = array_values($this->siblings);
    }

    // Фильтруем детей
    if (is_array($this->children)) {
        $this->children = array_filter($this->children, function($child) {
            return !empty($child['name']) || !empty($child['birth_year']);
        });
        $this->children = array_values($this->children);
    }
}
```

### 2. Интеграция фильтрации

Метод вызывается перед валидацией в:
- `nextStep()` - при переходе между шагами
- `submit()` - при финальной отправке формы

### 3. Принцип работы

1. **Определение пустых записей**: Запись считается пустой, если все её поля пустые
2. **Фильтрация**: Удаляются полностью пустые записи из массивов
3. **Переиндексация**: Массив переиндексируется для корректной валидации
4. **Валидация**: Применяется только к заполненным записям

## Примеры

### До исправления:
```php
$this->parents = [
    ['relation' => 'Отец', 'birth_year' => '1970', 'profession' => 'механик'],
    ['relation' => '', 'birth_year' => '', 'profession' => ''],
    ['relation' => '', 'birth_year' => '', 'profession' => '']
];
// Валидация требует заполнения всех 3 записей
```

### После исправления:
```php
$this->parents = [
    ['relation' => 'Отец', 'birth_year' => '1970', 'profession' => 'механик']
];
// Валидация применяется только к заполненной записи
```

## Правила валидации

Остались стандартными:
- `parents.*.relation` - обязательно, один из: Отец, Мать  
- `parents.*.birth_year` - обязательно, год от 1900 до текущего
- `parents.*.profession` - обязательно, строка до 255 символов
- `siblings.*.relation` - обязательно, один из: Брат, Сестра
- `siblings.*.birth_year` - обязательно, год от 1900 до текущего  
- `children.*.name` - обязательно, строка до 255 символов
- `children.*.birth_year` - обязательно, год от 1900 до текущего

## Результат

✅ Пользователь может указать только отца без ошибок валидации  
✅ Пустые записи автоматически удаляются  
✅ Заполненные записи валидируются корректно  
✅ Сохраняется только реальная информация о семье
